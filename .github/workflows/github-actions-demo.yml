name: Codespaces Capability Diagnostic
on: 
  workflow_dispatch:

jobs:
  diagnose-capabilities:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      options: --privileged
    
    steps:
      - name: Check Capabilities
        run: |
          echo "=== Checking Container Capabilities ==="
          if command -v capsh &> /dev/null; then
            capsh --print
          else
            apt-get update -qq && apt-get install -y libcap2-bin -qq
            capsh --print
          fi
          
      - name: Check for CAP_SYS_ADMIN
        run: |
          echo "=== Checking for CAP_SYS_ADMIN ==="
          grep Cap /proc/self/status || true
          
      - name: List Block Devices
        run: |
          echo "=== Available Block Devices ==="
          lsblk || true
          ls -la /dev/ | grep -E 'sd|loop|root' || true
          
      - name: Check Mount Permissions
        run: |
          echo "=== Testing Mount Capability (Diagnostic Only) ==="
          sudo mkdir -p /mnt/test_mount
          sudo mount -t ext4 /dev/root /mnt/test_mount
          cd ../../../../
          cd mnt/test_mount
          ls
          
      - name: Environment Report
        run: |
          echo "=== Environment Details ==="
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -a)"
          echo "Container Runtime: $(cat /proc/1/cgroup | head -5)"
          echo "User: $(id)"
