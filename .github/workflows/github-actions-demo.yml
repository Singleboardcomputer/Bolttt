name: Build V8 d8 (Fuzzilli) aarch64 (ASAN) and upload bundle

on:
  workflow_dispatch:

jobs:
  build-v8-fuzzilli-aarch64:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable QEMU emulation for ARM64
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build inside emulated ARM64 container
        run: |
          set -xeuo pipefail
          WORKDIR="${GITHUB_WORKSPACE}/v8_fuzzilli_build"
          mkdir -p "$WORKDIR"

          # Copy your build script into the working dir
          cp "${GITHUB_WORKSPACE}/build_in_docker.sh" "$WORKDIR/"
          chmod +x "$WORKDIR/build_in_docker.sh"

          # Run it inside an ARM64 Ubuntu container
          docker run --rm --platform=linux/arm64 \
            -v "${WORKDIR}:/work" \
            -w /work \
            ubuntu:22.04 \
            bash -lc "/work/build_in_docker.sh"

      - name: Upload artifact (bundle)
        uses: actions/upload-artifact@v4
        with:
          name: v8-d8-fuzzilli-aarch64-bundle
          path: v8_fuzzilli_build/v8_d8_fuzzilli_aarch64_bundle.tar.gz
