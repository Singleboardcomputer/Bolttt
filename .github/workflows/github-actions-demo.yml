name: Dependency Registry Check

on:
  push:
  pull_request:

jobs:
  dep-registry-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check pip and npm registries
        shell: bash
        run: |
          #!/usr/bin/env bash
          set -u

          # ---------- pip ----------
          if [ -x "./.venv/bin/pip" ]; then
            PIP_CMD="./.venv/bin/pip"
          elif command -v pip >/dev/null 2>&1; then
            PIP_CMD="pip"
          elif command -v pip3 >/dev/null 2>&1; then
            PIP_CMD="pip3"
          else
            PIP_CMD=""
          fi

          if [ -n "${PIP_CMD:-}" ]; then
            echo "### pip packages"
            $PIP_CMD list --format=freeze 2>/dev/null || $PIP_CMD list || true

            idx="$($PIP_CMD config get global.index-url 2>/dev/null || true)"
            [ -z "$idx" ] && idx="$($PIP_CMD config get index-url 2>/dev/null || true)"

            extra="$($PIP_CMD config get global.extra-index-url 2>/dev/null || true)"
            [ -z "$extra" ] && extra="$($PIP_CMD config get extra-index-url 2>/dev/null || true)"

            for url in "$idx" "$extra"; do
              [ -n "$url" ] || continue
              echo
              echo "pip registry: $url"
              curl -I --max-time 5 "$url" || true
            done
          else
            echo "### pip: not found"
          fi

          echo

          # ---------- npm ----------
          if command -v npm >/dev/null 2>&1; then
            echo "### npm packages (top-level, local)"
            npm ls --depth=0 2>/dev/null || true

            echo
            echo "### npm packages (top-level, global)"
            npm ls -g --depth=0 2>/dev/null || true

            reg="$(npm config get registry 2>/dev/null || true)"
            if [ -n "$reg" ]; then
              echo
              echo "npm registry: $reg"
              curl -I --max-time 5 "$reg" || true
            fi
          else
            echo "### npm: not found"
          fi
