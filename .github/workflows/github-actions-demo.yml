name: Build Pumpkin ARM64

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-arm64:
    runs-on: ubuntu-24.04

    steps:
    # 1. Clone Pumpkin explicitly
    - name: Clone Pumpkin repo
      run: |
        git clone https://github.com/Pumpkin-MC/Pumpkin.git
        cd Pumpkin
        git submodule update --init --recursive

    # 2. Install system deps for cross-compile
    - name: Install cross toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          pkg-config \
          libssl-dev

    # 3. Install Rust + target
    - name: Install Rust
      run: |
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source $HOME/.cargo/env
        rustup target add aarch64-unknown-linux-gnu

    # 4. Cross-compile Pumpkin (ARM64 ONLY)
    - name: Build Pumpkin (aarch64)
      run: |
        source $HOME/.cargo/env
        cd Pumpkin
        export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
        export PKG_CONFIG_ALLOW_CROSS=1
        cargo build -p pumpkin --release --target aarch64-unknown-linux-gnu

    # 5. Upload ARM64 binary
    - name: Upload ARM64 binary
      uses: actions/upload-artifact@v4
      with:
        name: pumpkin-linux-arm64
        path: Pumpkin/target/aarch64-unknown-linux-gnu/release/pumpkin
